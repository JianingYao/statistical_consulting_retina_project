---
title: "preprocess"
author: "Jianing Yao"
date: "2023-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/jianingyao/Desktop/School/JHU/Year2_Term3/Practice_Statistical_Consulting/Project/statistical_consulting_retina_project")
file_path = "/Users/jianingyao/Desktop/School/JHU/Year2_Term3/Practice_Statistical_Consulting/Project/statistical_consulting_retina_project"
library(readxl)
library(ggplot2)
library(dplyr)
library(tidyr)
library(corrplot)
```

### Step 1: read data and clean
```{r}
# read data
# the spreadsheet has 19 metabolic measures and 5 retinal thickness
data <- as.data.frame(read_excel("/Users/jianingyao/Desktop/School/JHU/Year2_Term3/Practice_Statistical_Consulting/Project/statistical_consulting_retina_project/Data/Sachdeva_Final_datasheet_OCT_metabolic_232023.xlsx"))

```

```{r}
# convert id and gender to factors
df <- data
df$IRB <- as.factor(df$IRB)
df$gender <- as.factor(df$gender)
levels(df$gender) <- c("male", "female")
df <- mutate(df, group = ifelse(HbA1c > 6.4, "DM", ifelse(HbA1c < 5.7, "Control", "Prediabetes")))
```

### Step 2: descriptive statistics
```{r}
# gender 
table(df$gender)
table(df$gender)/nrow(df)
```


```{r}
# diabetes groups
table(df$group)
table(df$group)/nrow(df)
```


## table 1: mean and sd of metabolic measures and retinal measures
```{r}
cols_ind <- c(4:112)
median_data <- apply(df[, cols_ind], 2, function(x) median(x, na.rm = TRUE))
mean_data <- apply(df[, cols_ind], 2, function(x) mean(x, na.rm = TRUE))
sd_data <- apply(df[, cols_ind], 2, function(x) sd(x, na.rm = TRUE))
n_data <- apply(df[, cols_ind], 2, function(x) sum(!is.na(x)))
summary <- cbind(median_data, mean_data, sd_data, n_data)
colnames(summary) <- c("Median", "Mean", "SD", "N")
round(summary,2)
summary <- round(summary,2)
write.csv(summary, "summary.csv", row.names = TRUE, col.names = TRUE)
```


## summary by groups

```{r}
cols_ind <- c(4:113)
summary_group <- df[cols_ind] %>% 
  group_by(group) %>%
    summarize_all(list(median = ~ median(., na.rm = TRUE), 
                     mean = ~ mean(., na.rm = TRUE), 
                     sd = ~ sd(., na.rm = TRUE)))
as.data.frame(t(summary_group))
write.csv(t(summary_group), "summary_group.csv", row.names = TRUE, col.names = TRUE)
```


## histograms of independent variables (age + metabolic measures)

```{r}
colnames(df)
indep_list <- c("age", "heart_rate","MAP","SBP","BMI","HbA1c","BUN","Cr","BUN/Cr","HDL","LDL","Triglycerides","Cholesterol","NEFA","Glucose","Ketone","Insulin","Adiponectin","Leptin","RAGE")
for (col in indep_list) {
  hist(df[[col]], xlab = paste(col), main = paste("Histogram of", col))
}

```


Important predictors: Adiponectin, Leptin, Cholesterol, HbA1c, gender, age


## replace missing values in metabolic measures with median
```{r}
met_list <- c("heart_rate","MAP","SBP","BMI","HbA1c","BUN","Cr","BUN/Cr","HDL","LDL","Triglycerides","Cholesterol","NEFA","Glucose","Ketone","Insulin","Adiponectin","Leptin","RAGE")
df.imp <- df
for (col in met_list) {
  df.imp[is.na(df.imp[[col]]), col] <- median(df.imp[[col]], na.rm = TRUE)
}
```




## Pairs plot, correlations, heatmap of metabolic measures

```{r}
pairs(df.imp[met_list])
```

```{r}
met_cor <- cor(df.imp[met_list], use = "pairwise.complete.obs")
corrplot(met_cor, type = "upper", method = "circle")
```

## Selected predictors heatmap

```{r}
predictors <- c("age","SBP","HbA1c","BUN/Cr","Cholesterol","Ketone","Adiponectin","Leptin","RAGE")
met_cor <- cor(df.imp[predictors], use = "pairwise.complete.obs")
corrplot(met_cor, type = "upper", method = "circle")
```


## Correlation heatmaps for retinal measures by eye
```{r}
# right eye
OD_list <- c(23:67)
OD_cor <- cor(df.imp[OD_list], use = "pairwise.complete.obs")
corrplot(OD_cor, type = "upper", method = "circle", tl.cex = 0.5)
```

```{r}
# left eye
OS_list <- c(68:112)
OS_cor <- cor(df.imp[OS_list], use = "pairwise.complete.obs")
corrplot(OS_cor, type = "upper", method = "circle", tl.cex = 0.5)
```


```{r}
# save cleaned dataset
write.table(df.imp, "data_cleaned.txt", sep = "\t", row.names = FALSE, col.names = TRUE)
```


## make a long table from a wide one

```{r}
right_eye_df <- df.imp[,!grepl("_OS",colnames(df.imp),ignore.case = FALSE)]
  
left_eye_df <-  df.imp[,!grepl("_OD",colnames(df.imp),ignore.case = FALSE)]

names(right_eye_df) = gsub(pattern = "_OD",
                           replacement = "",
                           x = names(right_eye_df))

names(left_eye_df) = gsub(pattern = "_OS",
                          replacement = "",
                          x = names(left_eye_df))

right_eye_df$eye <- "right"
left_eye_df$eye <- "left"

# Fix naming inconsistencies
names(left_eye_df)[names(left_eye_df) == 'TO_OR'] <- 'TO_ORT'
names(left_eye_df)[names(left_eye_df) == 'NO_TOS'] <- 'NO_TOT'
names(left_eye_df)[names(left_eye_df) == 'NO_GCL-IPL)'] <- 'NO_(GCL-IPL)'

df.imp.long <- rbind(right_eye_df,left_eye_df)
```



```{r}
# save long file
write.table(df.imp.long, "data_cleaned_long.txt", sep = "\t", row.names = FALSE, col.names = TRUE)
```


## histograms and descriptive analysis for total retinal thickness in 9 regions (for both eyes)


```{r}
ret_list <- seq(23, length = 9, by = 5)
for (col in colnames(df.imp.long[ret_list])) {
  hist(df.imp.long[[col]], xlab = paste(col), main = paste("Histogram of", col))
}
```


```{r}
cols_ind <- c(23:67)
median_data <- apply(df.imp.long[, cols_ind], 2, function(x) median(x, na.rm = TRUE))
mean_data <- apply(df.imp.long[, cols_ind], 2, function(x) mean(x, na.rm = TRUE))
sd_data <- apply(df.imp.long[, cols_ind], 2, function(x) sd(x, na.rm = TRUE))
n_data <- apply(df.imp.long[, cols_ind], 2, function(x) sum(!is.na(x)))
summary_long <- cbind(median_data, mean_data, sd_data, n_data)
colnames(summary_long) <- c("Median", "Mean", "SD", "N")
round(summary_long,2)
write.csv(round(summary_long,2), "summary_long.csv", row.names = TRUE, col.names = TRUE)
```


```{r}
cols_ind <- c(23:68)
summary_long_group <- df.imp.long[cols_ind] %>% 
  group_by(group) %>%
    summarize_all(list(median = ~ median(., na.rm = TRUE), 
                     mean = ~ mean(., na.rm = TRUE), 
                     sd = ~ sd(., na.rm = TRUE)))
summary_long_group
write.csv(as.data.frame(t(summary_long_group)), "summary_long_group.csv", row.names = TRUE, col.names = TRUE)

```


```{r}
cols_ind <- seq(23, length = 9, by = 5)
median_data <- apply(df.imp.long[, cols_ind], 2, function(x) median(x, na.rm = TRUE))
mean_data <- apply(df.imp.long[, cols_ind], 2, function(x) mean(x, na.rm = TRUE))
sd_data <- apply(df.imp.long[, cols_ind], 2, function(x) sd(x, na.rm = TRUE))
n_data <- apply(df.imp.long[, cols_ind], 2, function(x) sum(!is.na(x)))
summary_tot <- cbind(median_data, mean_data, sd_data, n_data)
colnames(summary_tot) <- c("Median", "Mean", "SD", "N")
round(summary_tot,2)
write.csv(round(summary_tot,2), "summary_tot.csv", row.names = TRUE, col.names = TRUE)

```



TODO:
1. histograms for retinal thickness 
2. descriptive by 3 groups?
3. missing values for metabolic measures (REPLACE WITH MEDIAN FOR NOW)
4. A heatmap showing correlations between selected metabolic parameters and retinal thickness values in each of the anatomical locations to select predictors.  




Questions: 
1. gender code: which is female vs male



